clear; clc; close all;

data = unpack_MPC("2024_YR4.txt");

% Ephemeris 2024 YR4 at JD TT = 2460600.5
% From MPC
a = 2.5370741*1.495978707e8;
e = 0.6638562;
i = 3.45180;
argp = 134.64369;
RAAN = 271.41255;
M = 351.06547;
n = 0.24389582;
X0 = MPC_to_orbit(a,e,i,RAAN,argp,M,n);
% From JPL Horizons
a = 3.798426562794065e+08;
e = 6.641400641819333e-01;
i = 3.452785235470560;
argp = 1.346422366023097e+2;
RAAN = 2.714123388372419e+2;
theta = 3.074395859965221e+2;
[r, v] = orbital_elements_to_rv(a,e,i,RAAN,argp,theta,1.327124400189e11);
X0 = [r;v];

JPL_X0 = [1.490564028447319e8; -1.995902566836032e7; 1.210407097519749e6;
    -9.096151730398509; 3.355424389651756e1; 1.400752719658557e1];

X0 = JPL_X0;

% Times (epoch start to 2032 close approach)
n = 5000;
JDi = juliandate(2024,10,17,0,0,0); % start date
JDf = juliandate(2032,12,23,0,0,0); % end date
span = (JDf - JDi)*86400; % time span in seconds
%span = 60*86400;
ts = linspace(0,span,n).';
JDs = JDi + (ts/86400);

% Pack ephemeris data to struct
ephemeris.dates = JDs;
ephemeris.sun = planetEphemeris(JDs,"SolarSystem","Sun","432t").';
ephemeris.venus = planetEphemeris(JDs,"SolarSystem","Venus","432t").';
ephemeris.earth = planetEphemeris(JDs,"SolarSystem","Earth","432t").';
ephemeris.moon = planetEphemeris(JDs,"SolarSystem","Moon","432t").';
ephemeris.mars = planetEphemeris(JDs,"SolarSystem","Mars","432t").';
ephemeris.jupiter = planetEphemeris(JDs,"SolarSystem","Jupiter","432t").';
% From https://ssd.jpl.nasa.gov/astro_par.html
ephemeris.mu_sun = 1.32712440041279419e11;
ephemeris.mu_venus = 324858.592000;
ephemeris.mu_earth = 398600.435507;
ephemeris.mu_moon = 4902.800118;
ephemeris.mu_mars = 42828.375816; % system, not planet
ephemeris.mu_jupiter = 126712764.100000; % system, not planet


% Numerically integrate with ode45
options = odeset('AbsTol',1e-14,'RelTol',1e-14);
[~, traj] = ode45(@(t,y) solar_system_force_model(t,y,ephemeris), ts, X0, options);

%% Plot trajectory
close all;
figure(1)
pa = plot3(traj(end,1),traj(end,2),traj(end,3),"ro","LineWidth",1);
hold on
plot3(traj(:,1),traj(:,2),traj(:,3),"r--","LineWidth",1)

% Plot Earth and Sun
pe = plot3(ephemeris.earth(1,end),ephemeris.earth(2,end),ephemeris.earth(3,end),"bo");
plot3(ephemeris.earth(1,:),ephemeris.earth(2,:),ephemeris.earth(3,:),"b-")

plot3(ephemeris.sun(1,1),ephemeris.sun(2,1),ephemeris.sun(3,1),"ko")

xlabel("x (km)")
ylabel("y (km)")
zlabel("z (km)")

legend("2024 YR4","2024 YR4 Trajectory","Earth","Earth Trajectory","Sun")
title("2024 YR4 Trajectory [17 Oct 2024 - 17 Oct 2032]")
axis equal

% Animated plot of markers
for k = n%1:10:n
    pa.XData = traj(k,1);
    pa.YData = traj(k,2);
    pa.ZData = traj(k,3);

    pe.XData = ephemeris.earth(1,k);
    pe.YData = ephemeris.earth(2,k);
    pe.ZData = ephemeris.earth(3,k);

    drawnow
end

%% Minimum distance

j = n;
tq = linspace(ts(n-2),ts(n),1000);
rs_ast = interpn(ts,traj(:,1:3),tq);
rs_ear = interpn(ts,ephemeris.earth(:,:).',tq);

dists = [];
for i = 1:1000
    dists(i) = norm(rs_ast(:,i) - rs_ear(:,i));
end

plot(tq,dists)
miss_distance = min(dists)